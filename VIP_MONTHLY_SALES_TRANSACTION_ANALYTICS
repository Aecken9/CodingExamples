create or replace view SOUTHERN_DISTILLING.ANALYTICS.VIP_MONTHLY_SALES_TRANSACTION_ANALYTICS(
	SUPPLIER,
	VIP_OUTLET_ID,
	ACCOUNT_NAME,
	ADDRESS,
	CITY,
	STATE,
	ZIP_CODE,
	COUNTY,
	PARENT_OWNER,
	SUB_DIVISION_OWNER,
	IMMEDIATE_OWNER,
	CHAIN_INDICATOR,
	FRANCHISE_INDICATOR,
	CHANNEL,
	SUB_CHANNEL,
	CUISINE_TYPE,
	PREMISE_TYPE,
	STORE_STATUS,
	SELLS_BEER,
	SELLS_WINE,
	SELLS_SPIRITS,
	LATITUDE,
	LONGITUDE,
	DISTRIBUTOR_ID,
	DISTRIBUTOR_NAME,
	DISTRIBUTOR_STATE,
	DISTRIBUTOR_AREA,
	ITEM_ID,
	CATEGORY,
	BRAND,
	SIZE,
	SKU,
	ITEM_NAME,
	POD_ID,
	MONTH_ENDING_DATE,
	YEAR,
	MONTH,
	"AGGREGATE",
	BOTTLE_VOLUME,
	BOTTLE_VOLUME_YAGO,
	CASE_VOLUME_PHYSICAL,
	CASE_VOLUME_PHYSICAL_YAGO,
	CASE_VOLUME_9L,
	CASE_VOLUME_9L_YAGO,
	FRONTLINE_SALES,
	FRONTLINE_SALES_YAGO,
	NET_SALES,
	NET_SALES_YAGO,
	SALES_FLAG,
	SALES_FLAG_YAGO
) as(

/* We first read in all pre-staged, rolling aggregate views created within the 
   staging schema. We then append each view into one cohesive data set. */ 
   
with
view_a as(
       select supplier,
              vip_outlet_id,
              distributor_id,
              item_id,
              pod_id,
              month_ending_date,
              year,
              month,
              aggregate,
              bottle_volume,
              bottle_volume_yago,
              case_volume_physical,
              case_volume_physical_yago,
              case_volume_9l,
              case_volume_9l_yago,
              frontline_sales,
              frontline_sales_yago,
              net_sales,
              net_sales_yago,
              sales_flag,
              sales_flag_yago
       from southern_distilling.staging.vip_sales_reporting_1mth
       union all
       select supplier,
              vip_outlet_id,
              distributor_id,
              item_id,
              pod_id,
              month_ending_date,
              year,
              month,
              aggregate,
              bottle_volume,
              bottle_volume_yago,
              case_volume_physical,
              case_volume_physical_yago,
              case_volume_9l,
              case_volume_9l_yago,
              frontline_sales,
              frontline_sales_yago,
              net_sales,
              net_sales_yago,
              sales_flag,
              sales_flag_yago
       from southern_distilling.staging.vip_sales_reporting_3mth
       union all
       select supplier,
              vip_outlet_id,
              distributor_id,
              item_id,
              pod_id,
              month_ending_date,
              year,
              month,
              aggregate,
              bottle_volume,
              bottle_volume_yago,
              case_volume_physical,
              case_volume_physical_yago,
              case_volume_9l,
              case_volume_9l_yago,
              frontline_sales,
              frontline_sales_yago,
              net_sales,
              net_sales_yago,
              sales_flag,
              sales_flag_yago
       from southern_distilling.staging.vip_sales_reporting_6mth
       union all
       select supplier,
              vip_outlet_id,
              distributor_id,
              item_id,
              pod_id,
              month_ending_date,
              year,
              month,
              aggregate,
              bottle_volume,
              bottle_volume_yago,
              case_volume_physical,
              case_volume_physical_yago,
              case_volume_9l,
              case_volume_9l_yago,
              frontline_sales,
              frontline_sales_yago,
              net_sales,
              net_sales_yago,
              sales_flag,
              sales_flag_yago
       from southern_distilling.staging.vip_sales_reporting_12mth
       union all
       select supplier,
              vip_outlet_id,
              distributor_id,
              item_id,
              pod_id,
              month_ending_date,
              year,
              month,
              aggregate,
              bottle_volume,
              bottle_volume_yago,
              case_volume_physical,
              case_volume_physical_yago,
              case_volume_9l,
              case_volume_9l_yago,
              frontline_sales,
              frontline_sales_yago,
              net_sales,
              net_sales_yago,
              sales_flag,
              sales_flag_yago
       from southern_distilling.staging.vip_sales_reporting_ytd),

/* We read in all pre-staged vip master outlet universe data to be joined
   to all rolling aggregated sales facts that we've appended in view_a. */ 

view_b as(
       select vip_outlet_id,
              account_name,
              address,
              city,
              state,
              zip_code,
              county,
              parent_owner,
              sub_division_owner,
              immediate_owner,
              chain_indicator,
              franchise_indicator,
              channel,
              sub_channel,
              cuisine_type,
              premise_type,
              store_status,
              sells_beer,
              sells_wine,
              sells_spirits,
              latitude,
              longitude
       from southern_distilling.staging.vip_master_outlet_xref),

/* We read in all pre-staged supplier master item data to be joined
   to all rolling aggregated sales facts that we've appended in view_a. */ 

view_c as(
       select item_id,
              category,
              brand,
              size,
              sku,
              item_name
       from southern_distilling.staging.vip_item_xref),

/* We read in all pre-staged distributor master geography data to be joined
   to all rolling aggregated sales facts that we've appended in view_a. */ 

view_d as(
       select distributor_id,
              distributor_name,
              distributor_state,
              distributor_area
       from southern_distilling.staging.vip_distributor_xref),

/* We then join all sales facts, vip outlet, supplier item, and distributor
   geography data into one cohesive and final data set view for reporting. */ 

view_e as(
       select view_a.supplier as supplier,
              view_a.vip_outlet_id as vip_outlet_id,
              coalesce(view_b.account_name, 'N/A') as account_name,
              coalesce(view_b.address, 'N/A') as address,
              coalesce(view_b.city, 'N/A') as city,
              coalesce(view_b.state, 'N/A') as state,
              coalesce(view_b.zip_code, 'N/A') as zip_code,
              coalesce(view_b.county, 'N/A') as county,
              coalesce(view_b.parent_owner, 'N/A') as parent_owner,
              coalesce(view_b.sub_division_owner, 'N/A') as sub_division_owner,
              coalesce(view_b.immediate_owner, 'N/A') as immediate_owner,
              coalesce(view_b.chain_indicator, 'N/A') as chain_indicator,
              coalesce(view_b.franchise_indicator, 'N/A') as franchise_indicator,
              coalesce(view_b.channel, 'N/A') as channel,
              coalesce(view_b.sub_channel, 'N/A') as sub_channel,
              coalesce(view_b.cuisine_type, 'N/A') as cuisine_type,
              coalesce(view_b.premise_type, 'N/A') as premise_type,
              coalesce(view_b.store_status, 'N/A') as store_status,
              coalesce(view_b.sells_beer, 'N/A') as sells_beer,
              coalesce(view_b.sells_wine, 'N/A') as sells_wine,
              coalesce(view_b.sells_spirits, 'N/A') as sells_spirits,
              coalesce(view_b.latitude, 'N/A') as latitude,
              coalesce(view_b.longitude, 'N/A') as longitude,
              view_a.distributor_id as distributor_id,
              coalesce(view_d.distributor_name, 'N/A') as distributor_name,
              coalesce(view_d.distributor_state, 'N/A') as distributor_state,
              coalesce(view_d.distributor_area, 'N/A') as distributor_area,
              view_a.item_id as item_id,
              coalesce(view_c.category, 'N/A') as category,
              coalesce(view_c.brand, 'N/A') as brand,
              coalesce(view_c.size, 'N/A') as size,
              coalesce(view_c.sku, 'N/A') as sku,
              coalesce(view_c.item_name, 'N/A') as item_name,
              view_a.pod_id as pod_id,
              view_a.month_ending_date as month_ending_date,
              view_a.year as year,
              view_a.month as month,
              view_a.aggregate as aggregate,
              view_a.bottle_volume as bottle_volume,
              view_a.bottle_volume_yago as bottle_volume_yago,
              view_a.case_volume_physical as case_volume_physical,
              view_a.case_volume_physical_yago as case_volume_physical_yago,
              view_a.case_volume_9l as case_volume_9l,
              view_a.case_volume_9l_yago as case_volume_9l_yago,
              view_a.frontline_sales as frontline_sales,
              view_a.frontline_sales_yago as frontline_sales_yago,
              view_a.net_sales as net_sales,
              view_a.net_sales_yago as net_sales_yago,
              view_a.sales_flag as sales_flag,
              view_a.sales_flag_yago as sales_flag_yago
       from view_a
       left join view_b on view_a.vip_outlet_id = view_b.vip_outlet_id
       left join view_c on view_a.item_id = view_c.item_id
       left join view_d on view_a.distributor_id = view_d.distributor_id)

select * from view_e);
